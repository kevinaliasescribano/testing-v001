<html>
	<head>
		<meta charset="utf-8">ï»¿
	</head>
	<body>
		<div id="divInfo">
			<input type="text" id="username">
			<input type="button" value="GO!" id="goButton">
		</div>
		<div id="divGame">
			<h3>Esto es CANVAS!</h3>
			<canvas id="canvas" style="border:solid 1px black; display:block;" width="600" height="300"></canvas>
			<div>
				<p>Puntos A: <span id="puntosA">0</span></p>
				<p>Puntos B: <span id="puntosB">0</span></p>
			</div>
		</div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script>

			(function(){
				
				var canvas = document.getElementById('canvas');
				var ctx = canvas.getContext('2d');
				var socket = io.connect("http://localhost:1337");
				
				var colorLineas = 'rgb(230,230,230)';
				var guardado = false;
				var creado = false;
				var posXact = 0;
				var posYact = 0;
				var squareSize = 28;
				var paintStop = false;
				var cuadrados = [];
				var bordesPintados = [];
				var cuadradoActual;
				var cuadradoAnterior;
				var playerA = new Player(1,'blue',0);
				var playerB = new Player(2,'yellow',0);
				var turnoPlayer = playerA;
				var x;
				var y;
				
				window.requestAnimationFrame = (function () {
					return window.requestAnimationFrame ||
						window.mozRequestAnimationFrame ||
						window.webkitRequestAnimationFrame ||
						function (callback) {
							window.setTimeout(callback, 17);
						};
				}());
				
				function paint(ctx){
					ctx.fillStyle = 'rgb(230,230,230)';
					ctx.fillRect(0,0,canvas.width,canvas.height);
					
					ctx.fillStyle = 'white';
					if(!creado){
						crearCuadrados(ctx);
					} else {
						pintarCuadrados(ctx);
					}
				}

				function crearCuadrados(ctx){
					posXact = 0;
					posYact = 0;
					cont = 0;
					while(!creado){
					
						bordesPintados = {top: [false, 'black'], right: [false, 'black'], bottom: [false, 'black'], left: [false, 'black']};
						if(posXact === 0 && posYact === 0){
							bordesPintados.top[0] = true;
							bordesPintados.left[0] = true;
						} else if(posXact === (canvas.width - squareSize - 2) && posYact === (canvas.height - squareSize - 2)){
							bordesPintados.right[0] = true;
							bordesPintados.bottom[0] = true;
						} else if (posXact === 0 && posYact === (canvas.height- squareSize - 2)){
							bordesPintados.left[0] = true;
							bordesPintados.bottom[0] = true;
						} else if (posXact === (canvas.width - squareSize - 2) && posYact === 0){
							bordesPintados.right[0] = true;
							bordesPintados.top[0] = true;
						} else if(posXact === 0){
							bordesPintados.left[0] = true;
						} else if(posYact === 0){
							bordesPintados.top[0] = true;
						} else if(posXact === (canvas.width - squareSize - 2)){
							bordesPintados.right[0] = true;
						} else if(posYact === (canvas.height - squareSize - 2)){
							bordesPintados.bottom[0] = true;
						}
						
						cuadrados.push(new Cuadrado(posXact + 1, posYact + 1, squareSize, 'white', bordesPintados, cont));
						posXact += squareSize + 2;
						if(posXact >= canvas.width){
							posXact = 0
							posYact += squareSize + 2;
							if(posYact >= canvas.height){
								creado = true;
							}
						}
						cont++;
					}
				}
				
				function pintarCuadrados(ctx){
					for(i in cuadrados){
						ctx.fillStyle = cuadrados[i].getColor();
						ctx.fillRect(cuadrados[i].values()[0],cuadrados[i].values()[1],cuadrados[i].values()[2],cuadrados[i].values()[2]);
						ctx.beginPath(); 
						if(cuadrados[i].getBordesPintados()['top'][0] === true){
							// LINEA ARRIBA
							ctx.fillStyle = cuadrados[i].getBordesPintados()['top'][1];
							ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[2]);
							ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[2]);
						}
						if(cuadrados[i].getBordesPintados()['right'][0] === true){
							// LINEA DERECHA
							ctx.fillStyle = cuadrados[i].getBordesPintados()['right'][1];
							ctx.moveTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[2]);
							ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[3]);
						}
						if(cuadrados[i].getBordesPintados()['bottom'][0] === true){
							// LINEA ABAJO
							ctx.fillStyle = cuadrados[i].getBordesPintados()['bottom'][1];
							ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[3]);
							ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[3]);
						}
						if(cuadrados[i].getBordesPintados()['left'][0] === true){
							// LINEA IZQUIERDA
							ctx.fillStyle = cuadrados[i].getBordesPintados()['left'][1];
							ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[2]);
							ctx.lineTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[3]);
						}
						for(j in cuadrados[i].getBordesPintados()){
							if(cuadrados[i].getBordesPintados()[j][0] === 'swap'){
								ctx.fillStyle = cuadrados[i].getBordesPintados()[j][1];
								if(j === 'top'){
									// LINEA ARRIBA
									ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[2]);
									ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[2]);
								}
								if(j === 'right'){
									// LINEA DERECHA
									ctx.moveTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[2]);
									ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[3]);
								}
								if(j === 'bottom'){
									// LINEA ABAJO
									ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[3]);
									ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[3]);
								}
								if(j === 'left'){
									// LINEA IZQUIERDA
									ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[2]);
									ctx.lineTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[3]);
								}
							}
						}
						ctx.stroke();
					}
					paintStop = true;
				}
				
				function Cuadrado(x,y,size,color,bordesPintados,id){
					this.x = x;
					this.y = y;
					this.size = size;
					this.color = color;
					this.bordesPintados = bordesPintados;
					this.id = id;
					this.colored = false;
					
					this.areaAbarcada = function(){
						return [this.x, this.x + this.size, this.y, this.y + this.size];
					}
					
					this.values = function(){
						return [this.x, this.y, this.size];
					}
					
					this.getColor = function(){
						return this.color;
					}
					
					this.setColor = function(color){
						this.color = color;
					}
					
					this.getBordesPintados = function(){
						return this.bordesPintados;
					}
					
					this.setBordesPintados = function(bordesPintados){
						this.bordesPintados = bordesPintados;
					}
					
					// 0 arriba, 1 derecha, 2 abajo, 3 izquierda
					this.pintarBorde = function(numeroBorde){
						this.bordesPintados[numeroBorde] = true;
					}
					
					this.getId = function(){
						return this.id;
					}
					
					this.changeColored = function(){
						this.colored = true;
					}
					
					this.getColored = function(){
						return this.colored;
					}
				}
				
				function Player(color, puntos){
					this.color = color;
					this.puntos = puntos;
					
					this.getPuntos = function(){
						return this.puntos;
					}
					
					this.setPuntos = function(puntos){
						this.puntos = puntos;
					}
					
					this.getColor = function(){
						return this.color;
					}
				}

				function moverRaton(evt, ctx){
					x = evt.x;
					y = evt.y;
					x -= canvas.offsetLeft;
					y -= canvas.offsetTop;
					
					for(i in cuadrados){
						if(x >= cuadrados[i].areaAbarcada()[0] && x <= cuadrados[i].areaAbarcada()[1] && y >= cuadrados[i].areaAbarcada()[2] && y <= cuadrados[i].areaAbarcada()[3]){
							cuadradoActual = cuadrados[i].getId();
							ctx.beginPath();
							var hoverOnElement = false;
							for(j in cuadrados[i].getBordesPintados()){
								if(cuadrados[i].getBordesPintados()[j] === 'swap'){
									hoverOnElement = true;
								} else if(cuadrados[i].getBordesPintados()[j] === 'on'){
									hoverOnElement = true;
								}
							}
							if(!hoverOnElement){
								if(cuadrados[i].getBordesPintados().top[0] === true){
									if(cuadrados[i].getBordesPintados().right[0] === true){
										if(cuadrados[i].getBordesPintados().bottom[0] === true){
											if(cuadrados[i].getBordesPintados().left[0] === true){
												ctx.moveTo(0,0);
												ctx.lineTo(0,0);
											} else {
												// LINEA IZQUIERDA
												cuadrados[i].getBordesPintados().left[0] = 'on';
												ctx.fillStyle = cuadrados[i].getBordesPintados().left[1];
												ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[2]);
												ctx.lineTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[3]);
											}
										} else {
											// LINEA ABAJO
											cuadrados[i].getBordesPintados().bottom[0] = 'on';
											ctx.fillStyle = cuadrados[i].getBordesPintados().bottom[1];
											ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[3]);
											ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[3]);
										}
									} else {
										// LINEA DERECHA
										cuadrados[i].getBordesPintados().right[0] = 'on';
										ctx.fillStyle = cuadrados[i].getBordesPintados().right[1];
										ctx.moveTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[2]);
										ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[3]);
									}
								} else {
									// LINEA ARRIBA
									cuadrados[i].getBordesPintados().top[0] = 'on';
									ctx.fillStyle = cuadrados[i].getBordesPintados().top[1];
									ctx.moveTo(cuadrados[i].areaAbarcada()[0],cuadrados[i].areaAbarcada()[2]);
									ctx.lineTo(cuadrados[i].areaAbarcada()[1],cuadrados[i].areaAbarcada()[2]);
								}
							}
							ctx.stroke();
						}
					}
					if(cuadradoAnterior === undefined){
						cuadradoAnterior = cuadradoActual;
					}
					if(cuadradoActual !== cuadradoAnterior){
						for(i in cuadrados[cuadradoAnterior].getBordesPintados()){
							if(cuadrados[cuadradoAnterior].getBordesPintados()[i][0] === 'swap'){
								cuadrados[cuadradoAnterior].getBordesPintados()[i][0] = false;
							}
						}
						pintarCuadrados(ctx);
						paintStop = false;
						cuadradoAnterior = cuadradoActual;
					} else {
					}
				}
				
				function pulsarTecla(evt, ctx){
					if(evt.keyCode == 32){
						for(i in cuadrados){
							if(x >= cuadrados[i].areaAbarcada()[0] && x <= cuadrados[i].areaAbarcada()[1] && y >= cuadrados[i].areaAbarcada()[2] && y <= cuadrados[i].areaAbarcada()[3]){
								iteracionCuadrado(cuadrados[i], ctx);
							}
						}
					}
				}
				
				function iteracionCuadrado(elem, ctx){
					var haveSwapBorder = false;
					for (i in elem.getBordesPintados()){
						if(elem.getBordesPintados()[i][0] === 'swap'){
							haveSwapBorder = true;
						}
					}
					if(haveSwapBorder){
						var borderWithSwap;
						var cambiado = false;
						var positions = ['top','right','bottom','left'];
						var token;
						for (i in elem.getBordesPintados()){
							if(elem.getBordesPintados()[i][0] === 'swap'){
								borderWithSwap = elem.getBordesPintados()[i];
								token = positions.indexOf(i) + 1;
							}
						}
						
						while(!cambiado){
							if(token > 3){
								token = 0;
							}
							var pos = positions[token];
							if(elem.getBordesPintados()[pos][0] === false){
								borderWithSwap[0] = false;
								elem.getBordesPintados()[positions[token]][0] = 'swap';
								borderWithSwap = elem.getBordesPintados()[pos];
								cambiado = true;
							} else if (elem.getBordesPintados()[positions[token]][0] === 'on'){
								borderWithSwap[0] = false;
								cambiado = true;
							} else {
								token++;
							}
						}
					} else {
						var borderWithOn;
						var cambiado = false;
						var positions = ['top','right','bottom','left'];
						var token;
						for (i in elem.getBordesPintados()){
							if(elem.getBordesPintados()[i][0] === 'on'){
								borderWithOn = elem.getBordesPintados()[i];
								token = positions.indexOf(i) + 1;
							}
						}
						
						while(!cambiado){
							if(token > 3){
								token = 0;
							}
							var pos = positions[token];
							if(elem.getBordesPintados()[pos][0] === false){
								elem.getBordesPintados()[positions[token]][0] = 'swap';
								cambiado = true;
							} else if (elem.getBordesPintados()[positions[token+1]][0] === 'on'){
								cambiado = true;
							} else {
								token++;
							}
						}
					}
					pintarCuadrados(ctx);
				}
				
				function clickRaton(evt, ctx){
					var swapedBorder = false;
					var changeTurn = true;
					x = evt.x;
					y = evt.y;
					x -= canvas.offsetLeft;
					y -= canvas.offsetTop;
					var cols = canvas.width / (squareSize + 2);
					var rows = canvas.height / (squareSize + 2);
					
					for(i in cuadrados){
						if(x >= cuadrados[i].areaAbarcada()[0] && x <= cuadrados[i].areaAbarcada()[1] && y >= cuadrados[i].areaAbarcada()[2] && y <= cuadrados[i].areaAbarcada()[3]){
							if(cuadrados[i].getColored() === false){
								for(j in cuadrados[i].getBordesPintados()){
									if(cuadrados[i].getBordesPintados()[j][0] == 'swap'){
										cuadrados[i].getBordesPintados()[j][0] = true;
										cuadrados[i].getBordesPintados()[j][1] = turnoPlayer.getColor();
										// COJER EL CUADRADO ANTERIOR Y MARCA TRUE AL BORDE OPUESTO A ESTE
										if(j === 'top'){
											if(cuadrados[parseInt(i)-cols] != undefined){
												cuadrados[parseInt(i)-cols].getBordesPintados()['bottom'][0] = true;
												cuadrados[parseInt(i)-cols].getBordesPintados()['bottom'][1] = turnoPlayer.getColor();
											}
										} else if(j === 'right'){
											if(cuadrados[parseInt(i)+1] != undefined){
												cuadrados[parseInt(i)+1].getBordesPintados()['left'][0] = true;
												cuadrados[parseInt(i)+1].getBordesPintados()['left'][1] = turnoPlayer.getColor();
											}
										} else if(j === 'bottom'){
											if(cuadrados[parseInt(i)+cols] != undefined){
												cuadrados[parseInt(i)+cols].getBordesPintados()['top'][0] = true;
												cuadrados[parseInt(i)+cols].getBordesPintados()['top'][1] = turnoPlayer.getColor();
											}
										} else if(j === 'left'){
											if(cuadrados[parseInt(i)-1] != undefined){
												cuadrados[parseInt(i)-1].getBordesPintados()['right'][0] = true;
												cuadrados[parseInt(i)-1].getBordesPintados()['right'][1] = turnoPlayer.getColor();
											}
										}
										swapedBorder = true;
									}
								}
								if(!swapedBorder){
									for(j in cuadrados[i].getBordesPintados()){
										if(cuadrados[i].getBordesPintados()[j][0] == 'on'){
											cuadrados[i].getBordesPintados()[j][0] = true;
											cuadrados[i].getBordesPintados()[j][1] = turnoPlayer.getColor();
											if(j === 'top'){
												if(cuadrados[parseInt(i)-cols] != undefined){
													cuadrados[parseInt(i)-cols].getBordesPintados()['bottom'][0] = true;
													cuadrados[parseInt(i)-cols].getBordesPintados()['bottom'][1] = turnoPlayer.getColor();
												}
											} else if(j === 'right'){
												if(cuadrados[parseInt(i)+1] != undefined){
													cuadrados[parseInt(i)+1].getBordesPintados()['left'][0] = true;
													cuadrados[parseInt(i)+1].getBordesPintados()['left'][1] = turnoPlayer.getColor();
												}
											} else if(j === 'bottom'){
												if(cuadrados[parseInt(i)+cols] != undefined){
													cuadrados[parseInt(i)+cols].getBordesPintados()['top'][0] = true;
													cuadrados[parseInt(i)+cols].getBordesPintados()['top'][1] = turnoPlayer.getColor();
												}
											} else if(j === 'left'){
												if(cuadrados[parseInt(i)-1] != undefined){
													cuadrados[parseInt(i)-1].getBordesPintados()['right'][0] = true;
													cuadrados[parseInt(i)-1].getBordesPintados()['right'][1] = turnoPlayer.getColor();
												}
											}
										}
									}
								}
								changeTurn = true;
								if(cuadrados[i].getBordesPintados()['top'][0] === true && cuadrados[i].getBordesPintados()['right'][0] === true && cuadrados[i].getBordesPintados()['bottom'][0] === true && cuadrados[i].getBordesPintados()['left'][0] === true){
									var puntosActuales = turnoPlayer.getPuntos();
									puntosActuales++;
									turnoPlayer.setPuntos(puntosActuales);
									if(turnoPlayer === playerA){
										document.getElementById('puntosA').childNodes[0].nodeValue = puntosActuales;
									} else if(turnoPlayer === playerB){
										document.getElementById('puntosB').childNodes[0].nodeValue = puntosActuales;
									}
									cuadrados[i].setColor(turnoPlayer.getColor());
									cuadrados[i].changeColored();
									ctx.fillStyle = cuadrados[i].getColor();
									ctx.fillRect(cuadrados[i].values()[0],cuadrados[i].values()[1],cuadrados[i].values()[2],cuadrados[i].values()[2]);
									console.log("ENTERO");
									changeTurn = false;
								}
							} else {
								changeTurn = false;
							}
							socket.emit('clickEvent', cuadrados[i].getBordesPintados(), cuadrados[i].getColor(), i);
						}
					}
					if(changeTurn){
						switchTurno();
					}
					console.log(changeTurn);
					paintStop = false;
				}
				
				function switchTurno(){
					if(turnoPlayer === playerA){
						turnoPlayer = playerB;
						document.getElementById('puntosA').style.backgroundColor = "white";
						document.getElementById('puntosB').style.backgroundColor = "yellow";
					} else if(turnoPlayer === playerB) {
						turnoPlayer = playerA;
						document.getElementById('puntosB').style.backgroundColor = "white";
						document.getElementById('puntosA').style.backgroundColor = "blue";
					}
				}
				
				function act(){
					
				}
				
				function run() {
					window.requestAnimationFrame(run);
					if(!paintStop){
						act();
						paint(ctx);
					}
				}
				
				function init() {
					run();
					enableSockets();
					$('#goButton').on('click',function(){
						$('#divGame').show();
						$('#divInfo').hide();
						socket.emit('join',$('#username').text());
					});
				}
				
				function enableSockets(){
					socket = io.connect();
					socket.on('enviarCuadrados', function(bordes, color, id){
						cuadrados[id].setColor(color);
						cuadrados[id].setBordesPintados(bordes);
						paintStop = false;
					});
					socket.on('newPlayer', function(username){
						
					});
				}
				
				window.onload = function(){
					init();
					if(turnoPlayer === playerA){
						document.getElementById('puntosA').style.backgroundColor = "blue";
						document.getElementById('puntosB').style.backgroundColor = "white";
					} else if(turnoPlayer === playerB) {
						document.getElementById('puntosB').style.backgroundColor = "yellow";
						document.getElementById('puntosA').style.backgroundColor = "white";
					}
					$('#divGame').hide();
				}
				
				document.addEventListener('keyup', function(evt){
					pulsarTecla(evt, ctx);
				});
				
				
				document.getElementById('canvas').addEventListener('mousemove', function(evt){
					moverRaton(evt, ctx);
				});
				
				document.getElementById('canvas').addEventListener("click", function(evt){
					clickRaton(evt, ctx);
				});
				
			}());

			(function(){
				document.getElementById('canvas').oncontextmenu = function(){
					return false;
				};
			}());
		</script>
	</body>
</html>